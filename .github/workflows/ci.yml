name: CI

on:
  push:
    branches: [dev, main]
  pull_request:
    branches: [main]

permissions:
  contents: write
  pull-requests: write

jobs:
  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: "temurin"
          java-version: "17"

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v4
        with:
          gradle-version: "8.1.1"

      - name: Build with Gradle
        run: gradle build --no-daemon

      - uses: actions/upload-artifact@v4
        with:
          name: mod-jar
          path: build/libs/*.jar
          retention-days: 1

  create-pr:
    name: PR
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/dev' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Create or update PR
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          PR=$(gh pr list --head dev --base main --state open --json number --jq '.[0].number // empty')
          
          COMMITS=$(git log origin/main..HEAD --oneline --no-merges | head -20)
          
          BODY="## Update Tensura Goblin Fix
          
          ### Changes from dev:
          \`\`\`
          ${COMMITS}
          \`\`\`
          
          Merging will auto-create a new release with version bump."
          
          if [ -z "$PR" ]; then
            gh pr create --head dev --base main --title "Update Tensura Goblin Fix" --body "$BODY"
          else
            gh pr edit "$PR" --body "$BODY"
          fi

  release:
    name: Release
    runs-on: ubuntu-latest
    needs: build
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/download-artifact@v4
        with:
          name: mod-jar
          path: build/libs/

      - name: Get next version
        id: v
        run: |
          LATEST_TAG=$(gh release list --limit 1 --json tagName --jq '.[0].tagName // empty')
          echo "Latest tag: $LATEST_TAG"
          
          if [ -z "$LATEST_TAG" ]; then
            NEW=$(grep "^version = " build.gradle | sed "s/version = '\(.*\)'/\1/")
            echo "First release, using build.gradle: $NEW"
          else
            CURRENT="${LATEST_TAG#v}"
            echo "Current version: $CURRENT"
            
            IFS='.' read -r MAJOR MINOR PATCH <<< "$CURRENT"
            PATCH=$((10#$PATCH + 1))
            
            NEW="$MAJOR.$MINOR.$PATCH"
            echo "Next version: $NEW"
          fi
          
          echo "ver=$NEW" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Update version in build files
        run: |
          VERSION="${{ steps.v.outputs.ver }}"
          sed -i "s/^version = .*/version = '$VERSION'/" build.gradle
          sed -i "s/^version = .*/version = \"$VERSION\"/" src/main/resources/META-INF/mods.toml
          echo "Updated version to $VERSION"

      - name: Create release
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          VERSION="${{ steps.v.outputs.ver }}"
          JAR_FILE=$(ls build/libs/tensura-goblin-fix-*.jar | grep -v sources | head -1)
          JAR_NAME=$(basename "$JAR_FILE")
          
          echo "Creating release v$VERSION"
          
          gh release create "v$VERSION" \
            --title "Tensura Goblin Fix v$VERSION" \
            --notes "## Tensura Goblin Fix v$VERSION
          
          ### Installation
          1. Download \`$JAR_NAME\`
          2. Place in your \`mods\` folder
          3. Requires **Minecraft Forge 1.19.2** and **Tensura mod**
          
          ### What this fixes
          Fixes the ArrayIndexOutOfBoundsException crash when rendering Tensura goblins with invalid Clothing values." \
            "$JAR_FILE"

      - name: Commit version bump
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add build.gradle src/main/resources/META-INF/mods.toml
          git diff --staged --quiet || git commit -m "chore: bump version to ${{ steps.v.outputs.ver }}"
          git push || true
